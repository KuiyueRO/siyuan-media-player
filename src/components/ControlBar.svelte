<script lang="ts">
    import { createEventDispatcher } from "svelte";
    import { showMessage } from "siyuan";
    import { showProFeatureNotEnabledMessage } from "../core/utils";
    
    // 创建事件分发器
    const dispatch = createEventDispatcher<{
        screenshot: void;      // 截图事件
        timestamp: void;       // 时间戳事件
        loopSegment: { action: string }; // 添加循环片段事件，携带动作参数
        playlist: void;        // 显示播放列表事件
        settings: void;        // 显示设置事件
        assistant: void;       // 助手事件
    }>();
    
    // 直接接收标题，用标题判断是否在播放
    export let title: string | null = null;
    export let loopStartTime: number | null = null;
    export let i18n: any; // 接收i18n对象
    export let proEnabled: boolean = false; // 接收Pro状态
    export let config: any; // 接收配置对象
    
    /**
     * 处理截图按钮点击
     */
    function handleScreenshot() {
        if (!title) {
            showMessage(i18n.controlBar.screenshot.hint);
            return;
        }
        dispatch('screenshot');
    }
    
    /**
     * 复制时间戳链接
     */
    function handleTimestamp() {
        if (!title) {
            showMessage(i18n.controlBar.timestamp.hint);
            return;
        }
        dispatch('timestamp');
    }
    
    /**
     * 复制循环片段链接
     */
    function handleLoopSegment() {
        if (!title) {
            showMessage(i18n.controlBar.loopSegment.hint);
            return;
        }
        
        if (loopStartTime === null) {
            // 第一次点击：记录开始时间
            dispatch('loopSegment', { action: 'start' });
            showMessage(i18n.controlBar.loopSegment.startHint);
        } else {
            // 第二次点击：记录结束时间并生成链接
            dispatch('loopSegment', { action: 'end' });
            showMessage(i18n.controlBar.loopSegment.endHint);
        }
    }
    
    // 处理播放列表按钮点击
    function handlePlaylist() {
        dispatch('playlist');
    }
    
    // 处理设置按钮点击
    function handleSettings() {
        dispatch('settings');
    }
    
    // 处理助手按钮点击
    function handleAssistant() {
        if (proEnabled) {
            dispatch('assistant');
        } else {
            showProFeatureNotEnabledMessage(i18n);
        }
    }
</script>

<div class="control-bar">
    <!-- 左侧工具按钮区域 -->
    <div class="left-controls">
        <!-- 截图按钮 -->
        <button 
            class="control-btn" 
            on:click={handleScreenshot}
            title={i18n.controlBar.screenshot.name}
        >
            <svg viewBox="0 0 1024 1024" class="icon">
                <path d="M853.333333 170.666667a73.142857 73.142857 0 0 1 73.142857 73.142857v536.380952a73.142857 73.142857 0 0 1-73.142857 73.142857H170.666667a73.142857 73.142857 0 0 1-73.142857-73.142857V243.809524a73.142857 73.142857 0 0 1 73.142857-73.142857h682.666666z m0 73.142857H170.666667v536.380952h682.666666V243.809524z m-375.856762 168.057905l120.685715 120.685714 51.687619-51.712 172.422095 172.373333-51.712 51.736381-120.685714-120.685714-51.736381 51.736381-120.685715-120.685714-224.109714 224.109714-51.712-51.687619 275.846095-275.870476zM731.428571 292.571429a48.761905 48.761905 0 1 1 0 97.523809 48.761905 48.761905 0 0 1 0-97.523809z"/>
            </svg>
        </button>
        
        <!-- 时间戳按钮 -->
        <button 
            class="control-btn" 
            on:click={handleTimestamp}
            title={i18n.controlBar.timestamp.name}
        >
            <svg viewBox="0 0 1024 1024" class="icon">
                <path d="M511.292952 121.904762c80.408381 0 155.087238 24.405333 217.136762 66.218667l-49.737143 49.785904a318.756571 318.756571 0 0 0-167.399619-47.152762C334.189714 190.756571 190.610286 334.57981 190.610286 512s143.60381 321.243429 320.682666 321.243429c177.103238 0 320.682667-143.823238 320.682667-321.243429 0-49.127619-11.02019-95.695238-30.72-137.337905l51.102476-51.078095A388.87619 388.87619 0 0 1 900.681143 512c0 215.454476-174.32381 390.095238-389.36381 390.095238C296.228571 902.095238 121.904762 727.454476 121.904762 512S296.228571 121.904762 511.292952 121.904762z m0 137.679238c42.179048 0 81.968762 10.386286 116.906667 28.769524l-51.955809 51.931428a182.54019 182.54019 0 0 0-64.950858-11.849142c-101.180952 0-183.247238 82.16381-183.247238 183.56419 0 101.376 82.041905 183.588571 183.247238 183.588571s183.247238-82.212571 183.247238-183.588571a185.295238 185.295238 0 0 0-2.194285-28.42819l56.344381-56.32c9.435429 26.477714 14.57981 55.003429 14.579809 84.74819 0 139.410286-112.810667 252.416-251.977143 252.416-139.142095 0-251.952762-113.005714-251.952762-252.416s112.810667-252.416 251.952762-252.416zM853.577143 143.433143L902.095238 192.146286 566.613333 527.676952l-51.102476 2.681905 2.535619-51.297524 335.481905-335.62819z"/>
            </svg>
        </button>

        <!-- 循环片段按钮 -->
        <button 
            class="control-btn" 
            on:click={handleLoopSegment}
            title={i18n.controlBar.loopSegment.name}
        >
            <svg viewBox="0 0 1024 1024" class="icon">
                <path d="M1020.562286 846.555429q0 43.885714-43.885715 43.885714h-50.029714v85.284571q0 18.212571-12.873143 31.085715t-31.012571 12.873142q-43.885714 0-43.885714-43.885714v-85.357714H140.726857q-43.885714 0-43.885714-43.885714V215.04H45.348571q-43.885714 0-43.885714-43.885714t43.885714-43.885715h51.565715V48.493714q0-43.885714 43.885714-43.885714t43.885714 43.885714V127.268571h698.148572q18.139429 0 31.012571 12.873143 12.8 12.873143 12.8 31.012572v631.588571h50.102857q43.885714 0 43.885715 43.812572z m-181.686857-43.885715V215.04H184.612571v587.702857h654.262858z"/>
                {#if !loopStartTime}
                <path d="M608.256 321.609143q-41.106286-17.773714-86.308571-17.773714-45.129143 0-86.162286 17.627428-35.401143 15.213714-63.341714 41.618286v-9.947429q0-14.043429-10.020572-23.990857-9.874286-9.801143-23.771428-9.801143t-23.844572 10.020572q-10.020571 9.947429-10.020571 23.771428V470.308571q0 14.116571 10.020571 24.064 9.947429 9.801143 23.844572 9.801143h117.174857q14.043429 0 23.990857-10.020571 9.801143-9.947429 9.801143-23.844572 0-13.824-10.020572-23.844571-9.947429-9.947429-23.771428-9.947429h-43.885715q19.602286-25.746286 48.859429-40.228571 33.645714-16.603429 71.460571-13.750857 50.980571 3.876571 87.478858 40.521143 36.571429 36.571429 40.082285 87.478857 4.242286 60.416-37.010285 104.448-40.96 43.885714-100.937143 43.885714-43.739429 0-79.36-25.161143-34.742857-24.576-49.883429-64.365714-4.388571-11.702857-14.409143-18.797714-10.093714-7.094857-22.308571-7.094857-20.187429 0-32.182857 16.530285-11.922286 16.676571-4.973715 35.401143 24.137143 65.097143 81.334858 104.155429 58.733714 40.155429 130.413714 37.156571 84.260571-33.364571 144.457143-63.561143 60.196571-60.050286 63.634285-144.091428 1.828571-45.494857-14.482285-87.332572-15.725714-40.374857-45.933715-71.68-30.208-31.232-69.924571-48.420571z"/>
                {/if}
            </svg>
        </button>
    </div>
    
    <!-- 中间标题区域 -->
    <div class="title-area">
        <span class="media-title">
            {title || i18n.controlBar.notPlaying}
        </span>
    </div>
    
    <!-- 右侧功能按钮区域 -->
    <div class="right-controls">
         <!-- 助手按钮 -->
         <button 
         class="control-btn" 
         on:click={handleAssistant}
         title={i18n?.controlBar?.assistant?.name || "助手"}
         >
             <svg viewBox="0 0 1024 1024" class="icon">
                 <path d="M510.4 220.8c-156.8 0-284.8 128-284.8 284.8s128 284.8 284.8 284.8 284.8-128 284.8-284.8-128-284.8-284.8-284.8z m0 489.6c-113.6 0-204.8-91.2-204.8-204.8 0-113.6 91.2-204.8 204.8-204.8s204.8 91.2 204.8 204.8c0 113.6-91.2 204.8-204.8 204.8zM633.6 820.8H388.8c-22.4 0-40 17.6-40 40s17.6 40 40 40h244.8c22.4 0 40-17.6 40-40s-17.6-40-40-40zM569.6 929.6h-118.4c-22.4 0-40 17.6-40 40s17.6 40 40 40h118.4c22.4 0 40-17.6 40-40s-17.6-40-40-40zM510.4 179.2c24 0 43.2-19.2 43.2-43.2V52.8c0-24-19.2-43.2-43.2-43.2s-43.2 19.2-43.2 43.2v83.2c0 22.4 19.2 43.2 43.2 43.2zM276.8 275.2c17.6-17.6 17.6-44.8 0-60.8l-59.2-59.2c-8-8-19.2-12.8-30.4-12.8s-22.4 4.8-30.4 12.8c-9.6 8-12.8 19.2-12.8 30.4s4.8 22.4 12.8 30.4l59.2 59.2c8 8 19.2 12.8 30.4 12.8s20.8-4.8 30.4-12.8zM864 155.2c-8-8-19.2-12.8-30.4-12.8s-22.4 4.8-30.4 12.8l-59.2 59.2c-17.6 17.6-17.6 44.8 0 60.8 8 8 19.2 12.8 30.4 12.8s22.4-4.8 30.4-12.8l59.2-59.2c17.6-16 17.6-43.2 0-60.8zM136 462.4H52.8c-24 0-43.2 19.2-43.2 43.2s19.2 43.2 43.2 43.2h83.2c24 0 43.2-19.2 43.2-43.2s-19.2-43.2-43.2-43.2zM968 462.4h-83.2c-24 0-43.2 19.2-43.2 43.2s19.2 43.2 43.2 43.2h83.2c24 0 43.2-19.2 43.2-43.2s-19.2-43.2-43.2-43.2z"/>
             </svg>
         </button>
     
        <!-- 播放列表按钮 -->
        <button 
            class="control-btn" 
            on:click={handlePlaylist}
            title={i18n.controlBar.playlist.name}
        >
            <svg viewBox="0 0 1024 1024" class="icon">
                <path d="M414.47619 121.904762a73.142857 73.142857 0 0 1 73.142858 73.142857v219.428571a73.142857 73.142857 0 0 1-73.142858 73.142858H195.047619a73.142857 73.142857 0 0 1-73.142857-73.142858V195.047619a73.142857 73.142857 0 0 1 73.142857-73.142857h219.428571zM195.047619 195.047619v219.428571h219.428571V195.047619H195.047619z m219.428571 341.333333a73.142857 73.142857 0 0 1 73.142858 73.142858v219.428571a73.142857 73.142857 0 0 1-73.142858 73.142857H195.047619a73.142857 73.142857 0 0 1-73.142857-73.142857v-219.428571a73.142857 73.142857 0 0 1 73.142857-73.142858h219.428571z m-219.428571 73.142858v219.428571h219.428571v-219.428571H195.047619zM536.380952 182.857143v73.142857h353.52381v-73.142857H536.380952zM536.380952 609.52381v73.142857h353.52381v-73.142857H536.380952z m0-268.190477v73.142857h353.52381v-73.142857H536.380952z m0 426.666667v73.142857h353.52381v-73.142857H536.380952z"/>
            </svg>
        </button>
        
        <!-- 设置按钮 -->
        <button 
            class="control-btn" 
            on:click={handleSettings}
            title={i18n.controlBar.settings.name}
        >
            <svg viewBox="0 0 1024 1024" class="icon">
                <path d="M448.487619 97.52381l130.096762 0.170666c40.399238 0.073143 73.142857 32.792381 73.191619 73.216l0.048762 21.211429a345.283048 345.283048 0 0 1 71.143619 39.960381l17.408-10.044953a73.313524 73.313524 0 0 1 99.961905 26.819048l65.219047 112.566857a73.313524 73.313524 0 0 1-22.893714 97.816381l-3.974095 2.438095-17.481143 10.093715a341.479619 341.479619 0 0 1-1.292191 83.968l12.361143 7.168a73.313524 73.313524 0 0 1 28.867048 96.329142l-2.023619 3.803429-61.098667 105.813333a73.313524 73.313524 0 0 1-96.329143 28.867048l-3.803428-2.048-16.896-9.752381a341.918476 341.918476 0 0 1-68.291048 38.083048l0.024381 29.062095a73.313524 73.313524 0 0 1-68.754286 73.264762l-4.632381 0.146285-130.121142-0.170666a73.313524 73.313524 0 0 1-73.191619-73.216l-0.048762-35.035429a346.599619 346.599619 0 0 1-57.368381-34.035809l-31.158857 17.944381a73.313524 73.313524 0 0 1-99.986286-26.819048l-65.219048-112.566857a73.313524 73.313524 0 0 1 22.918095-97.816381l3.949715-2.438095 31.719619-18.285715c-2.438095-23.161905-2.56-46.665143-0.219429-70.119619l-35.206095-20.333714a73.313524 73.313524 0 0 1-28.891429-96.329143l2.048-3.803428 61.098667-105.813334a73.313524 73.313524 0 0 1 96.329143-28.867047l3.803429 2.048 30.72 17.724952a341.284571 341.284571 0 0 1 64.609523-39.716571l-0.048762-27.89181a73.313524 73.313524 0 0 1 68.754286-73.264762L448.487619 97.52381z m-0.097524 73.313523l0.073143 74.48381-42.130286 19.846095c-18.041905 8.46019-35.05981 18.919619-50.761142 31.158857l-38.936381 30.403048-71.655619-41.398857-1.852953-1.024-61.074286 105.813333 76.239239 44.007619-4.729905 47.104a268.434286 268.434286 0 0 0 0.170666 55.100952l5.022477 47.445334-73.069715 42.081524 65.194667 112.566857 72.557714-41.740191 38.473143 28.184381a272.579048 272.579048 0 0 0 45.226667 26.819048l42.057143 19.772952 0.146285 81.529905 130.072381 0.170667-0.073143-78.019048 45.202286-18.822095a268.629333 268.629333 0 0 0 53.638095-29.915429l38.448762-27.648 57.904762 33.426286 61.049905-105.813333-55.100952-31.890286 6.826666-48.88381a268.190476 268.190476 0 0 0 1.024-65.950476l-5.12-47.494095 58.928762-34.011429-65.219047-112.566857L718.262857 319.390476l-38.497524-28.086857a272.62781 272.62781 0 0 0-56.051809-31.50019l-45.104762-18.724572-0.121905-70.070857-130.096762-0.170667z m145.895619 210.407619a146.773333 146.773333 0 0 1 53.686857 200.362667 146.407619 146.407619 0 0 1-200.167619 53.638095 146.773333 146.773333 0 0 1-53.662476-200.362666 146.407619 146.407619 0 0 1 200.167619-53.638096z m-136.655238 90.258286a73.48419 73.48419 0 0 0 26.86781 100.278857 73.118476 73.118476 0 0 0 99.961904-26.770285c19.529143-33.865143 9.020952-76.824381-23.186285-98.03581l-3.657143-2.267429-3.803429-2.048a73.118476 73.118476 0 0 0-96.182857 28.842667z"/>
            </svg>
        </button>
    </div>
</div> 