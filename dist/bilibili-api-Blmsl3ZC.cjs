"use strict";var k=Object.defineProperty,V=Object.defineProperties;var N=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var x=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable;var _=(d,i,t)=>i in d?k(d,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[i]=t,S=(d,i)=>{for(var t in i||(i={}))x.call(i,t)&&_(d,t,i[t]);if(b)for(var t of b(i))A.call(i,t)&&_(d,t,i[t]);return d},v=(d,i)=>V(d,N(i));var T=(d,i)=>{var t={};for(var s in d)x.call(d,s)&&i.indexOf(s)<0&&(t[s]=d[s]);if(d!=null&&b)for(var s of b(d))i.indexOf(s)<0&&A.call(d,s)&&(t[s]=d[s]);return t};var E=(d,i,t)=>_(d,typeof i!="symbol"?i+"":i,t);var m=(d,i,t)=>new Promise((s,c)=>{var l=f=>{try{r(t.next(f))}catch(e){c(e)}},h=f=>{try{r(t.throw(f))}catch(e){c(e)}},r=f=>f.done?s(f.value):Promise.resolve(f.value).then(l,h);r((t=t.apply(d,i)).next())});Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const P=require("./dash-tools-BbXzIJ0H.cjs"),K=require("./artplayer-DAOzTqI4.cjs");function W(d,i){for(var t=0;t<i.length;t++){const s=i[t];if(typeof s!="string"&&!Array.isArray(s)){for(const c in s)if(c!=="default"&&!(c in d)){const l=Object.getOwnPropertyDescriptor(s,c);l&&Object.defineProperty(d,c,l.get?l:{enumerable:!0,get:()=>s[c]})}}}return Object.freeze(Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}))}const $={qrcode:()=>Promise.resolve().then(()=>require("./qrcode-BA824ERi.cjs")).then(d=>d.browser),md5:()=>Promise.resolve().then(()=>z)};class I{static getMixinKey(i){return m(this,null,function*(){return this.MIXIN_KEY_ENC_TAB.map(t=>i[t]).join("").slice(0,32)})}static encWbi(i,t,s){return m(this,null,function*(){const c=yield this.getMixinKey(t+s),l=Math.round(Date.now()/1e3),h=/[!'()*]/g;i=v(S({},i),{wts:l});const r=Object.keys(i).sort().map(e=>{const a=i[e].toString().replace(h,"");return`${encodeURIComponent(e)}=${encodeURIComponent(a)}`}).join("&"),f=yield $.md5();return r+"&w_rid="+f.default(r+c)})}static getWbiKeysFromConfig(i){var c,l,h,r;if(!((l=(c=i==null?void 0:i.bilibiliLogin)==null?void 0:c.userInfo)!=null&&l.wbi_img))return null;const{img_url:t,sub_url:s}=i.bilibiliLogin.userInfo.wbi_img;return{imgKey:((h=t.split("/").pop())==null?void 0:h.split(".")[0])||"",subKey:((r=s.split("/").pop())==null?void 0:r.split(".")[0])||""}}static proxyRequest(s){return m(this,arguments,function*(i,t={}){try{const l=yield(yield fetch(this.API.PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:i,method:"GET",timeout:7e3,contentType:"application/json",headers:Object.entries(t).map(([h,r])=>({[h]:r}))})})).json();if(l.code!==0)throw new Error(`代理请求失败: ${l.msg}`);return JSON.parse(l.data.body)}catch(c){throw new Error(`代理请求失败: ${c instanceof Error?c.message:String(c)}`)}})}static extractVideoId(i){try{const t=new URL(i);if(t.hostname==="b23.tv")return null;const s=parseInt(t.searchParams.get("p")||"1"),c=t.pathname.match(/\/(BV[\w]+)/);if(c)return{bvid:c[1],p:s};const l=t.searchParams.get("aid"),h=t.searchParams.get("bvid");return l?{aid:l,p:s}:h?{bvid:h,p:s}:null}catch(t){return null}}static getVideoPages(i){return m(this,null,function*(){try{const t=yield this.proxyRequest(`${this.API.VIDEO_PAGES}?${new URLSearchParams(i).toString()}`);return t.code===0&&Array.isArray(t.data)?t.data:[]}catch(t){return[]}})}static formatDuration(i){const t=Math.floor(i/3600),s=Math.floor(i%3600/60),c=i%60;return t>0?`${t}:${s.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`:`${s}:${c.toString().padStart(2,"0")}`}static generateQRCode(i){return m(this,null,function*(){try{return yield(yield $.qrcode()).default.toDataURL(i,{width:200,margin:2,color:{dark:"#000000",light:"#ffffff"}})}catch(t){throw new Error(`生成二维码失败: ${t instanceof Error?t.message:String(t)}`)}})}static extractSessData(i){try{return new URL(i).searchParams.get("SESSDATA")}catch(t){return null}}static getRequestHeaders(i,t){var c;const s={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",Referer:t?`https://www.bilibili.com/video/${t}/`:"https://www.bilibili.com",Origin:"https://www.bilibili.com"};if((c=i.bilibiliLogin)!=null&&c.url){const l=this.extractSessData(i.bilibiliLogin.url);if(l)s.Cookie=`SESSDATA=${l}`;else{const h=new URL(i.bilibiliLogin.url),r=Array.from(h.searchParams.entries()).filter(([f])=>f!=="url").map(([f,e])=>`${f}=${e}`).join("; ");r&&(s.Cookie=r)}}return s}static getVideoInfo(i){return m(this,null,function*(){const t=this.extractVideoId(i);if(!t)return null;try{const s=t,{p:c}=s,l=T(s,["p"]),h=yield this.proxyRequest(`${this.API.VIDEO_INFO}?${new URLSearchParams(l).toString()}`);if(h.code===0){const r=h.data,f=yield this.getVideoPages(l);let e=r.cid;if(f.length>0){const a=Math.min(Math.max(1,c||1),f.length)-1;e=f[a].cid,f.length>1&&(r.title=`${r.title} - P${a+1}${f[a].part?": "+f[a].part:""}`)}return{url:i,title:r.title,artist:r.owner.name,artistIcon:r.owner.face,duration:this.formatDuration(r.duration),thumbnail:r.pic,aid:String(r.aid),bvid:r.bvid,cid:String(e)}}return null}catch(c){return null}})}static getLoginQRCode(){return m(this,null,function*(){try{const i=yield this.proxyRequest(this.API.QR_LOGIN);if(i.code!==0||!i.data)throw new Error(`获取二维码失败: ${i.message}`);return{qrcodeData:yield this.generateQRCode(i.data.url),qrcode_key:i.data.qrcode_key}}catch(i){throw new Error(`获取二维码失败: ${i instanceof Error?i.message:String(i)}`)}})}static checkQRCodeStatus(i){return m(this,null,function*(){try{const t=yield this.proxyRequest(`${this.API.QR_POLL}?qrcode_key=${i}`);if(t.code===0&&t.data.code===0){const s=this.extractSessData(t.data.url),c=s?yield this.getUserInfo(s):null;return{code:0,message:"登录成功",url:t.data.url,refresh_token:t.data.refresh_token,timestamp:t.data.timestamp,userInfo:c}}return{code:t.data.code,message:t.data.message||"未知状态"}}catch(t){throw new Error(`检查二维码状态失败: ${t instanceof Error?t.message:String(t)}`)}})}static getUserInfo(i){return m(this,null,function*(){try{const t=yield this.proxyRequest(this.API.USER_INFO,{Cookie:`SESSDATA=${i}`});if(t.code===0){const{face:s,level_info:c,mid:l,uname:h,wbi_img:r}=t.data;return{face:s,level_info:c,mid:l,uname:h,wbi_img:r?{img_url:r.img_url,sub_url:r.sub_url}:void 0}}throw new Error(t.message||"获取用户信息失败")}catch(t){throw new Error(`获取用户信息失败: ${t instanceof Error?t.message:String(t)}`)}})}static getVideoUrl(i,t,s,c){return m(this,null,function*(){const l={bvid:i,cid:t,qn:s,fnval:16,fnver:0,fourk:1,platform:"html5",high_quality:1},h=this.getWbiKeysFromConfig(c);if(!h)throw new Error("无法获取WBI签名密钥");const r=yield this.encWbi(l,h.imgKey,h.subKey),f=this.getRequestHeaders(c,i);try{const e=yield this.proxyRequest(`${this.API.VIDEO_STREAM}?${r}`,f);if(e.data.durl)e.data.dash={video:[{id:e.data.quality,baseUrl:decodeURIComponent(e.data.durl[0].url),codecs:"avc1.640032",bandwidth:e.data.durl[0].size,frameRate:"30"}],audio:[]};else if(e.data.dash)e.data.dash.video&&(e.data.dash.video=e.data.dash.video.map(a=>v(S({},a),{baseUrl:decodeURIComponent(a.baseUrl)}))),e.data.dash.audio&&(e.data.dash.audio=e.data.dash.audio.map(a=>v(S({},a),{baseUrl:decodeURIComponent(a.baseUrl)})));else throw new Error("不支持的视频格式");return e}catch(e){throw new Error(`获取视频流失败: ${e instanceof Error?e.message:String(e)}`)}})}static getProcessedVideoStream(i,t,s,c){return m(this,null,function*(){for(let h=0;h<3;h++)try{const r=yield this.getVideoUrl(i,t,s,c);if(!r.data.dash&&!r.data.durl)throw new Error("不支持的视频格式");let f=null,e=null;if(r.data.durl)f={id:r.data.quality,baseUrl:r.data.durl[0].url,codecs:"avc1.640032",bandwidth:r.data.durl[0].size,frameRate:"30"};else{const a=r.data.dash.video||[],n=h>0?null:s;f=P.selectBestStream(a,n);try{const o=P.generateMPD(r),u=new Blob([o],{type:"application/dash+xml"});e=URL.createObjectURL(u)}catch(o){}}if(!f)throw new Error("无法获取合适的播放流");return{video:{url:f.baseUrl,quality:f.id,codecs:f.codecs,bandwidth:f.bandwidth,frameRate:f.frameRate},headers:this.getRequestHeaders(c,i),mpdUrl:e}}catch(r){if(h===2)throw new Error(`获取播放流失败: ${r instanceof Error?r.message:String(r)}`);yield new Promise(f=>setTimeout(f,1e3*Math.pow(2,h)))}throw new Error("无法获取播放流")})}}E(I,"API",{BASE:"https://api.bilibili.com",PROXY:"/api/network/forwardProxy",QR_LOGIN:"https://passport.bilibili.com/x/passport-login/web/qrcode/generate",QR_POLL:"https://passport.bilibili.com/x/passport-login/web/qrcode/poll",USER_INFO:"https://api.bilibili.com/x/web-interface/nav",VIDEO_INFO:"https://api.bilibili.com/x/web-interface/view",VIDEO_PAGES:"https://api.bilibili.com/x/player/pagelist",VIDEO_STREAM:"https://api.bilibili.com/x/player/wbi/playurl"}),E(I,"MIXIN_KEY_ENC_TAB",[46,47,18,2,53,8,23,32,15,50,10,31,58,3,45,35,27,43,5,49,33,9,42,19,29,28,14,39,12,38,41,13,37,48,7,16,24,55,40,61,26,17,0,1,60,51,30,4,22,25,54,21,56,59,6,63,57,62,11,36,20,34,44,52]);var O={exports:{}},U={exports:{}};(function(){var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i={rotl:function(t,s){return t<<s|t>>>32-s},rotr:function(t,s){return t<<32-s|t>>>s},endian:function(t){if(t.constructor==Number)return i.rotl(t,8)&16711935|i.rotl(t,24)&4278255360;for(var s=0;s<t.length;s++)t[s]=i.endian(t[s]);return t},randomBytes:function(t){for(var s=[];t>0;t--)s.push(Math.floor(Math.random()*256));return s},bytesToWords:function(t){for(var s=[],c=0,l=0;c<t.length;c++,l+=8)s[l>>>5]|=t[c]<<24-l%32;return s},wordsToBytes:function(t){for(var s=[],c=0;c<t.length*32;c+=8)s.push(t[c>>>5]>>>24-c%32&255);return s},bytesToHex:function(t){for(var s=[],c=0;c<t.length;c++)s.push((t[c]>>>4).toString(16)),s.push((t[c]&15).toString(16));return s.join("")},hexToBytes:function(t){for(var s=[],c=0;c<t.length;c+=2)s.push(parseInt(t.substr(c,2),16));return s},bytesToBase64:function(t){for(var s=[],c=0;c<t.length;c+=3)for(var l=t[c]<<16|t[c+1]<<8|t[c+2],h=0;h<4;h++)c*8+h*6<=t.length*8?s.push(d.charAt(l>>>6*(3-h)&63)):s.push("=");return s.join("")},base64ToBytes:function(t){t=t.replace(/[^A-Z0-9+\/]/ig,"");for(var s=[],c=0,l=0;c<t.length;l=++c%4)l!=0&&s.push((d.indexOf(t.charAt(c-1))&Math.pow(2,-2*l+8)-1)<<l*2|d.indexOf(t.charAt(c))>>>6-l*2);return s}};U.exports=i})();var Q=U.exports,R={utf8:{stringToBytes:function(d){return R.bin.stringToBytes(unescape(encodeURIComponent(d)))},bytesToString:function(d){return decodeURIComponent(escape(R.bin.bytesToString(d)))}},bin:{stringToBytes:function(d){for(var i=[],t=0;t<d.length;t++)i.push(d.charCodeAt(t)&255);return i},bytesToString:function(d){for(var i=[],t=0;t<d.length;t++)i.push(String.fromCharCode(d[t]));return i.join("")}}},F=R;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var j=function(d){return d!=null&&(q(d)||G(d)||!!d._isBuffer)};function q(d){return!!d.constructor&&typeof d.constructor.isBuffer=="function"&&d.constructor.isBuffer(d)}function G(d){return typeof d.readFloatLE=="function"&&typeof d.slice=="function"&&q(d.slice(0,0))}(function(){var d=Q,i=F.utf8,t=j,s=F.bin,c=function(l,h){l.constructor==String?h&&h.encoding==="binary"?l=s.stringToBytes(l):l=i.stringToBytes(l):t(l)?l=Array.prototype.slice.call(l,0):!Array.isArray(l)&&l.constructor!==Uint8Array&&(l=l.toString());for(var r=d.bytesToWords(l),f=l.length*8,e=1732584193,a=-271733879,n=-1732584194,o=271733878,u=0;u<r.length;u++)r[u]=(r[u]<<8|r[u]>>>24)&16711935|(r[u]<<24|r[u]>>>8)&4278255360;r[f>>>5]|=128<<f%32,r[(f+64>>>9<<4)+14]=f;for(var p=c._ff,g=c._gg,w=c._hh,y=c._ii,u=0;u<r.length;u+=16){var B=e,C=a,L=n,D=o;e=p(e,a,n,o,r[u+0],7,-680876936),o=p(o,e,a,n,r[u+1],12,-389564586),n=p(n,o,e,a,r[u+2],17,606105819),a=p(a,n,o,e,r[u+3],22,-1044525330),e=p(e,a,n,o,r[u+4],7,-176418897),o=p(o,e,a,n,r[u+5],12,1200080426),n=p(n,o,e,a,r[u+6],17,-1473231341),a=p(a,n,o,e,r[u+7],22,-45705983),e=p(e,a,n,o,r[u+8],7,1770035416),o=p(o,e,a,n,r[u+9],12,-1958414417),n=p(n,o,e,a,r[u+10],17,-42063),a=p(a,n,o,e,r[u+11],22,-1990404162),e=p(e,a,n,o,r[u+12],7,1804603682),o=p(o,e,a,n,r[u+13],12,-40341101),n=p(n,o,e,a,r[u+14],17,-1502002290),a=p(a,n,o,e,r[u+15],22,1236535329),e=g(e,a,n,o,r[u+1],5,-165796510),o=g(o,e,a,n,r[u+6],9,-1069501632),n=g(n,o,e,a,r[u+11],14,643717713),a=g(a,n,o,e,r[u+0],20,-373897302),e=g(e,a,n,o,r[u+5],5,-701558691),o=g(o,e,a,n,r[u+10],9,38016083),n=g(n,o,e,a,r[u+15],14,-660478335),a=g(a,n,o,e,r[u+4],20,-405537848),e=g(e,a,n,o,r[u+9],5,568446438),o=g(o,e,a,n,r[u+14],9,-1019803690),n=g(n,o,e,a,r[u+3],14,-187363961),a=g(a,n,o,e,r[u+8],20,1163531501),e=g(e,a,n,o,r[u+13],5,-1444681467),o=g(o,e,a,n,r[u+2],9,-51403784),n=g(n,o,e,a,r[u+7],14,1735328473),a=g(a,n,o,e,r[u+12],20,-1926607734),e=w(e,a,n,o,r[u+5],4,-378558),o=w(o,e,a,n,r[u+8],11,-2022574463),n=w(n,o,e,a,r[u+11],16,1839030562),a=w(a,n,o,e,r[u+14],23,-35309556),e=w(e,a,n,o,r[u+1],4,-1530992060),o=w(o,e,a,n,r[u+4],11,1272893353),n=w(n,o,e,a,r[u+7],16,-155497632),a=w(a,n,o,e,r[u+10],23,-1094730640),e=w(e,a,n,o,r[u+13],4,681279174),o=w(o,e,a,n,r[u+0],11,-358537222),n=w(n,o,e,a,r[u+3],16,-722521979),a=w(a,n,o,e,r[u+6],23,76029189),e=w(e,a,n,o,r[u+9],4,-640364487),o=w(o,e,a,n,r[u+12],11,-421815835),n=w(n,o,e,a,r[u+15],16,530742520),a=w(a,n,o,e,r[u+2],23,-995338651),e=y(e,a,n,o,r[u+0],6,-198630844),o=y(o,e,a,n,r[u+7],10,1126891415),n=y(n,o,e,a,r[u+14],15,-1416354905),a=y(a,n,o,e,r[u+5],21,-57434055),e=y(e,a,n,o,r[u+12],6,1700485571),o=y(o,e,a,n,r[u+3],10,-1894986606),n=y(n,o,e,a,r[u+10],15,-1051523),a=y(a,n,o,e,r[u+1],21,-2054922799),e=y(e,a,n,o,r[u+8],6,1873313359),o=y(o,e,a,n,r[u+15],10,-30611744),n=y(n,o,e,a,r[u+6],15,-1560198380),a=y(a,n,o,e,r[u+13],21,1309151649),e=y(e,a,n,o,r[u+4],6,-145523070),o=y(o,e,a,n,r[u+11],10,-1120210379),n=y(n,o,e,a,r[u+2],15,718787259),a=y(a,n,o,e,r[u+9],21,-343485551),e=e+B>>>0,a=a+C>>>0,n=n+L>>>0,o=o+D>>>0}return d.endian([e,a,n,o])};c._ff=function(l,h,r,f,e,a,n){var o=l+(h&r|~h&f)+(e>>>0)+n;return(o<<a|o>>>32-a)+h},c._gg=function(l,h,r,f,e,a,n){var o=l+(h&f|r&~f)+(e>>>0)+n;return(o<<a|o>>>32-a)+h},c._hh=function(l,h,r,f,e,a,n){var o=l+(h^r^f)+(e>>>0)+n;return(o<<a|o>>>32-a)+h},c._ii=function(l,h,r,f,e,a,n){var o=l+(r^(h|~f))+(e>>>0)+n;return(o<<a|o>>>32-a)+h},c._blocksize=16,c._digestsize=16,O.exports=function(l,h){if(l==null)throw new Error("Illegal argument "+l);var r=d.wordsToBytes(c(l,h));return h&&h.asBytes?r:h&&h.asString?s.bytesToString(r):d.bytesToHex(r)}})();var M=O.exports;const H=K.getDefaultExportFromCjs(M),z=W({__proto__:null,default:H},[M]);exports.BilibiliParser=I;
